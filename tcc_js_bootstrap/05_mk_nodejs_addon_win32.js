load("tcc_em.js");
FS.mkdir("include");
FS.mkdir("include/node");
f={
  "bootstrap.c":"../tests/nodejs/bootstrap.c",
  "binding.c":"../tests/nodejs/binding.c",
  "binding_linux.c":"../tests/nodejs/binding_linux.c",
  "common.h":"../tests/nodejs/common.h",
  "binding.h":"../tests/nodejs/binding.h",
  "include/node/node_api.h":"../tests/nodejs/include/node/node_api.h",
  "include/node/node_api_types.h":"../tests/nodejs/include/node/node_api_types.h"
}
for(i in f){
  FS.writeFile(i, read(f[i]));
};
//args="-c bootstrap.c -I . -I include/node/ -o out.o"
args="-nostdinc -nostdlib -I /usr/include/:/usr/include/i386-linux-gnu/:/tmp/tcc/lib/tcc/include/ -c bootstrap.c -I . -I include/node/ -o out.o"
args=args.split(" ");
print(JSON.stringify(args));
Module.arguments=args;
obj_name="../tests/nodejs/lib/addon.o";
compile(obj_name);

mm={};
ctypes={};
ctypes.voidptr_t=function(){return 0};

mmap_base=0;
libc.mmap=function(){
  print("mmap called");
  return mmap_base;
};
malloc_i=0;
malloc_bases=[0,0,8192,8192+1792];
libc.malloc=function(){
  print("malloc called");
  var r=malloc_bases[malloc_i];
  malloc_i++;
  return r;
}
libc.memcpy=function(){
  return 0;
}
load("../lib/elf_loader.js");

obj=mm.decode_elf(read(obj_name,"binary"));
//print(JSON.stringify(obj.und,null,"  "));

out=new Uint8Array(7168);

header=[
0x4d,0x5a,0x90,0x00,0x03,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0xff,0xff,0x00,0x00,
0xb8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,
0x0e,0x1f,0xba,0x0e,0x00,0xb4,0x09,0xcd,0x21,0xb8,0x01,0x4c,0xcd,0x21,0x54,0x68,
0x69,0x73,0x20,0x70,0x72,0x6f,0x67,0x72,0x61,0x6d,0x20,0x63,0x61,0x6e,0x6e,0x6f,
0x74,0x20,0x62,0x65,0x20,0x72,0x75,0x6e,0x20,0x69,0x6e,0x20,0x44,0x4f,0x53,0x20,
0x6d,0x6f,0x64,0x65,0x2e,0x0d,0x0d,0x0a,0x24,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x50,0x45,0x00,0x00,0x4c,0x01,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0xe0,0x00,0x0e,0x23,0x0b,0x01,0x06,0x00,0x00,0x10,0x00,0x00,
0x00,0x0a,0x00,0x00,0x00,0x00,0x00,0x00,0x38,0x1e,0x00,0x00,0x00,0x10,0x00,0x00,
0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x10,0x00,0x00,0x00,0x02,0x00,0x00,
0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x40,0x00,0x00,0x00,0x02,0x00,0x00,0xd1,0xfb,0x00,0x00,0x02,0x00,0x00,0x00,
0x00,0x00,0x10,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x10,0x00,0x00,
0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x26,0x00,0x00,0x5b,0x00,0x00,0x00,
0x00,0x23,0x00,0x00,0x50,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x30,0x00,0x00,0x84,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x50,0x23,0x00,0x00,0x68,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x2e,0x74,0x65,0x78,0x74,0x00,0x00,0x00,
0x30,0x0f,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x02,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x60,
0x2e,0x64,0x61,0x74,0x61,0x00,0x00,0x00,0x7c,0x06,0x00,0x00,0x00,0x20,0x00,0x00,
0x00,0x08,0x00,0x00,0x00,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x40,0x00,0x00,0xc0,0x2e,0x72,0x65,0x6c,0x6f,0x63,0x00,0x00,
0x84,0x00,0x00,0x00,0x00,0x30,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x1a,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x42,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
];
for(var i=0;i<header.length;i++){
out[i]=header[i];
};

Export_Table = {
  "VirtualAddress": 9728,
  "Size": 91,
  "Data":[
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x32,0x26,0x00,0x00,
0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x28,0x26,0x00,0x00,
0x2c,0x26,0x00,0x00,0x30,0x26,0x00,0x00,0x28,0x1d,0x00,0x00,0x43,0x26,0x00,0x00,
0x00,0x00,0x61,0x64,0x64,0x6f,0x6e,0x5f,0x77,0x69,0x6e,0x33,0x32,0x2e,0x6e,0x6f,
0x64,0x65,0x00,0x6e,0x61,0x70,0x69,0x5f,0x72,0x65,0x67,0x69,0x73,0x74,0x65,0x72,
0x5f,0x6d,0x6f,0x64,0x75,0x6c,0x65,0x5f,0x76,0x31,0x00
  ]
};
et=Export_Table;
Import_Table = {
  "VirtualAddress": 8960,
  "Size": 80,
  "Data":[
0xb8,0x23,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x24,0x00,0x00,
0x50,0x23,0x00,0x00,0xd0,0x23,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x57,0x24,0x00,0x00,0x68,0x23,0x00,0x00,0xdc,0x23,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x84,0x24,0x00,0x00,0x74,0x23,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
  ]
};
it=Import_Table;
Base_Relocation_Table = {
  "VirtualAddress": 12288,
  "Size":0,
  "Data": []
};
brt=Base_Relocation_Table;
IAT = {
  "VirtualAddress": 9040,
  "Size": 104,
  "Data":[
0x2b,0x24,0x00,0x00,0x34,0x24,0x00,0x00,0x3e,0x24,0x00,0x00,0x45,0x24,0x00,0x00,
0x4e,0x24,0x00,0x00,0x00,0x00,0x00,0x00,0x64,0x24,0x00,0x00,0x73,0x24,0x00,0x00,
0x00,0x00,0x00,0x00,0x8d,0x24,0x00,0x00,0xa0,0x24,0x00,0x00,0xbb,0x24,0x00,0x00,
0xd7,0x24,0x00,0x00,0xea,0x24,0x00,0x00,0xf8,0x24,0x00,0x00,0x0f,0x25,0x00,0x00,
0x24,0x25,0x00,0x00,0x3f,0x25,0x00,0x00,0x5b,0x25,0x00,0x00,0x70,0x25,0x00,0x00,
0x8a,0x25,0x00,0x00,0x9c,0x25,0x00,0x00,0xb1,0x25,0x00,0x00,0xc8,0x25,0x00,0x00,
0xe2,0x25,0x00,0x00,0x00,0x00,0x00,0x00
  ]
};
iat=IAT;
Section_Headers = {
  ".text": {
    "Name": ".text",
    "VirtualSize": 3888,
    "VirtualAddress": 4096,
    "SizeOfRawData": 4096,
    "PointerToRawData": 512,
    "PointerToRelocations": 0,
    "PointerToLinenumbers": 0,
    "NumberOfRelocations": 0,
    "NumberOfLinenumbers": 0,
    "Characteristics": 1610612768
  },
  ".data": {
    "Name": ".data",
    "VirtualSize": 1660,
    "VirtualAddress": 8192,
    "SizeOfRawData": 2048,
    "PointerToRawData": 4608,
    "PointerToRelocations": 0,
    "PointerToLinenumbers": 0,
    "NumberOfRelocations": 0,
    "NumberOfLinenumbers": 0,
    "Characteristics": -1073741760
  },
  ".reloc": {
    "Name": ".reloc",
    "VirtualSize": 132,
    "VirtualAddress": 12288,
    "SizeOfRawData": 512,
    "PointerToRawData": 6656,
    "PointerToRelocations": 0,
    "PointerToLinenumbers": 0,
    "NumberOfRelocations": 0,
    "NumberOfLinenumbers": 0,
    "Characteristics": 1107296320
  }
};
ts=Section_Headers[".text"];
ds=Section_Headers[".data"];
rs=Section_Headers[".reloc"];

function f_off(s,a){
  return a-s.VirtualAddress+s.PointerToRawData;
};
function hex(x){
  return "0x"+x.toString(16);
};
et_off=f_off(ds,Export_Table.VirtualAddress);
print("Export_Table f_off: "+hex(et_off));
it_off=f_off(ds,Import_Table.VirtualAddress);
print("Import_Table f_off: "+hex(it_off));
brt_off=f_off(rs,Base_Relocation_Table.VirtualAddress);
print("Base_Relocation_Table f_off: "+hex(brt_off));
iat_off=f_off(ds,IAT.VirtualAddress);
print("IAT f_off: "+hex(iat_off));

for(var i=0;i<et.Size;i++){
  out[i+et_off]=et.Data[i];
};

for(var i=0;i<it.Size;i++){
  out[i+it_off]=it.Data[i];
};

for(var i=0;i<iat.Size;i++){
  out[i+iat_off]=iat.Data[i];
};

Import_Directory_Table = [];
idt = Import_Directory_Table;

function get_u32(x,o){
  return x[0+o]+(x[1+o]<<8)+(x[2+o]<<16)+(x[3+o]<<24);
};

d=it.Data;
xo=0;
for(var i=0;i<3;i++){
  t={};
  t.Import_Lookup_Table_RVA=get_u32(d,xo);
  xo+=4;
  t.Date_Time_Stamp=get_u32(d,xo);
  xo+=4;
  t.Forwarder_Chain=get_u32(d,xo);
  xo+=4;
  t.Name_RVA=get_u32(d,xo);
  xo+=4;
  t.Import_Address_Table_RVA=get_u32(d,xo);
  xo+=4;
  idt.push(t);
};

print(JSON.stringify(idt,null,"  "));
idt.map(function(x){
  for(i in x){
    print(i+" "+hex(f_off(ds,x[i])));
  };
print("");
});

// this is the import lookup table offset
ilt_off=f_off(ds,idt[0].Import_Lookup_Table_RVA);
for(var i=0;i<iat.Size;i++){
  out[i+ilt_off]=iat.Data[i];
};


Hint_Name_Table=[
0x6d,0x73,0x76,0x63,0x72,0x74,0x2e,0x64,0x6c,0x6c,0x00,0x00,0x00,0x70,0x72,0x69,
0x6e,0x74,0x66,0x00,0x00,0x00,0x73,0x70,0x72,0x69,0x6e,0x74,0x66,0x00,0x00,0x00,
0x70,0x75,0x74,0x73,0x00,0x00,0x00,0x73,0x74,0x72,0x6c,0x65,0x6e,0x00,0x00,0x00,
0x6d,0x65,0x6d,0x73,0x65,0x74,0x00,0x6b,0x65,0x72,0x6e,0x65,0x6c,0x33,0x32,0x2e,
0x64,0x6c,0x6c,0x00,0x00,0x00,0x4c,0x6f,0x61,0x64,0x4c,0x69,0x62,0x72,0x61,0x72,
0x79,0x41,0x00,0x00,0x00,0x47,0x65,0x74,0x50,0x72,0x6f,0x63,0x41,0x64,0x64,0x72,
0x65,0x73,0x73,0x00,0x6e,0x6f,0x64,0x65,0x2e,0x65,0x78,0x65,0x00,0x00,0x00,0x6e,
0x61,0x70,0x69,0x5f,0x67,0x65,0x74,0x5f,0x63,0x62,0x5f,0x69,0x6e,0x66,0x6f,0x00,
0x00,0x00,0x6e,0x61,0x70,0x69,0x5f,0x67,0x65,0x74,0x5f,0x6c,0x61,0x73,0x74,0x5f,
0x65,0x72,0x72,0x6f,0x72,0x5f,0x69,0x6e,0x66,0x6f,0x00,0x00,0x00,0x6e,0x61,0x70,
0x69,0x5f,0x69,0x73,0x5f,0x65,0x78,0x63,0x65,0x70,0x74,0x69,0x6f,0x6e,0x5f,0x70,
0x65,0x6e,0x64,0x69,0x6e,0x67,0x00,0x00,0x00,0x6e,0x61,0x70,0x69,0x5f,0x74,0x68,
0x72,0x6f,0x77,0x5f,0x65,0x72,0x72,0x6f,0x72,0x00,0x00,0x00,0x6e,0x61,0x70,0x69,
0x5f,0x74,0x79,0x70,0x65,0x6f,0x66,0x00,0x00,0x00,0x6e,0x61,0x70,0x69,0x5f,0x67,
0x65,0x74,0x5f,0x76,0x61,0x6c,0x75,0x65,0x5f,0x69,0x6e,0x74,0x33,0x32,0x00,0x00,
0x00,0x6e,0x61,0x70,0x69,0x5f,0x69,0x73,0x5f,0x74,0x79,0x70,0x65,0x64,0x61,0x72,
0x72,0x61,0x79,0x00,0x00,0x00,0x6e,0x61,0x70,0x69,0x5f,0x67,0x65,0x74,0x5f,0x74,
0x79,0x70,0x65,0x64,0x61,0x72,0x72,0x61,0x79,0x5f,0x69,0x6e,0x66,0x6f,0x00,0x00,
0x00,0x6e,0x61,0x70,0x69,0x5f,0x67,0x65,0x74,0x5f,0x61,0x72,0x72,0x61,0x79,0x62,
0x75,0x66,0x66,0x65,0x72,0x5f,0x69,0x6e,0x66,0x6f,0x00,0x00,0x00,0x6e,0x61,0x70,
0x69,0x5f,0x63,0x72,0x65,0x61,0x74,0x65,0x5f,0x64,0x6f,0x75,0x62,0x6c,0x65,0x00,
0x00,0x00,0x6e,0x61,0x70,0x69,0x5f,0x63,0x72,0x65,0x61,0x74,0x65,0x5f,0x73,0x74,
0x72,0x69,0x6e,0x67,0x5f,0x75,0x74,0x66,0x38,0x00,0x00,0x00,0x6e,0x61,0x70,0x69,
0x5f,0x67,0x65,0x74,0x5f,0x67,0x6c,0x6f,0x62,0x61,0x6c,0x00,0x00,0x00,0x6e,0x61,
0x70,0x69,0x5f,0x63,0x61,0x6c,0x6c,0x5f,0x66,0x75,0x6e,0x63,0x74,0x69,0x6f,0x6e,
0x00,0x00,0x00,0x6e,0x61,0x70,0x69,0x5f,0x63,0x72,0x65,0x61,0x74,0x65,0x5f,0x66,
0x75,0x6e,0x63,0x74,0x69,0x6f,0x6e,0x00,0x00,0x00,0x6e,0x61,0x70,0x69,0x5f,0x73,
0x65,0x74,0x5f,0x6e,0x61,0x6d,0x65,0x64,0x5f,0x70,0x72,0x6f,0x70,0x65,0x72,0x74,
0x79,0x00,0x00,0x00,0x6e,0x61,0x70,0x69,0x5f,0x64,0x65,0x66,0x69,0x6e,0x65,0x5f,
0x70,0x72,0x6f,0x70,0x65,0x72,0x74,0x69,0x65,0x73,0x00,0x00,0x00,0x00,0x00,0x00
];
hnt=Hint_Name_Table;

hnt_base=0x1620;
for(var i=0;i<hnt.length;i++){
  out[i+hnt_base]=hnt[i];
};

data=obj.sections[".data"].raw;
for(i=0;i<data.length;i++){
  out[ds.PointerToRawData+i]=data[i];
};

syms={};
ex=obj.exports;
for(var i=0;i<ex.length;i++){
  syms[ex[i].st_name]=ex[i];
};

// this is a hack to strip out a bunch of crap glibc adds to our binary
ctypes_open_off=syms["ctypes_open"].address;

// load the object code again since we need to shift the load address
// by ctypes_open_off bytes
ImageBase=0x10000000;
mmap_base=ImageBase+4096-ctypes_open_off;

obj=mm.decode_elf(read(obj_name,"binary"));
// dummy imports
obj.imports=[];
// do relocations
obj.relocate_all();

text=obj.sections[".text"].raw;
for(i=0;i<text.length-ctypes_open_off;i++){
  out[ts.PointerToRawData+i]=text[i+ctypes_open_off];
};

try{
  fs.writeFileSync("../tests/nodejs/lib/addon_win32.node",out);
} catch(e){
  print("couldn't use fs, we must be in SM");
}
